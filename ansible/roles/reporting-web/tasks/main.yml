---
# TODO: for from-base role, templatize /etc/httpd/conf.d/wsgi_edware.conf

# Note: the smarter.ini retemaplte happens in  edware/tasks/main
# Here, we're just watching to see if it changes, and if so, restart apache.
# Normally we'd put a handler in edware, but edware role is used by several apps, 
# most of which don't have httpd.
- name: Restart apache if smarter.ini changed
  service:
    name: httpd
    state: restarted
  when: smarter_ini.changed # This is a task reference registered by the edware role

- name: Configure IDP sso
  copy: src=files/{{ ec2_tag_environment }}/idp_metadata.xml dest=/opt/edware/conf/idp_metadata.xml
  notify: restart httpd 

- name: Install mod_ssl
  yum: name=mod_ssl state=latest

- name: get appropriate SSL certs
  shell: 'aws s3 sync --sse s3://srl-{{ec2_tag_environment}}-apache-internal-ssl/reporting-web /etc/pki/tls/'

- name: Configure Apache SSL
  template: src=ssl.conf dest=/etc/httpd/conf.d/ssl.conf
  notify: restart httpd

- name: Add Slash Rewrite
  template: src=rewrite-slash.conf dest=/etc/httpd/conf.d/rewrite-slash.conf
  notify: restart httpd

- name: Rewrite http to https
  template: src=rewrite-http.conf dest=/etc/httpd/conf.d/rewrite-http.conf
  notify: restart httpd
